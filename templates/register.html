<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Face - Face Recognition System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen" x-data="registerForm()">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-camera text-2xl text-blue-600"></i>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-xl font-semibold text-gray-900">Face Recognition System</h1>
                        <p class="text-sm text-gray-500">Enterprise Edition</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="/register" class="text-blue-600 hover:text-blue-800 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-user-plus mr-2"></i>Register
                    </a>
                    <a href="/scan" class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-search mr-2"></i>Scan
                    </a>
                    <a href="/logs" class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-list mr-2"></i>Logs
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-user-plus mr-3 text-blue-600"></i>
                    Register New Face
                </h2>
                <p class="text-gray-600 mt-1">Add a new person to the face recognition system</p>
            </div>

            <!-- Form -->
            <form @submit.prevent="submitForm" class="p-6 space-y-6">
                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                            Full Name <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="name" 
                            x-model="form.name"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter full name"
                        >
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            Email Address
                        </label>
                        <input 
                            type="email" 
                            id="email" 
                            x-model="form.email"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter email address"
                        >
                    </div>
                </div>

                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Face Image <span class="text-red-500">*</span>
                    </label>
                    
                    <!-- Drag & Drop Zone -->
                    <div 
                        class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors"
                        :class="{ 'border-blue-500 bg-blue-50': isDragOver }"
                        @dragover.prevent="isDragOver = true"
                        @dragleave.prevent="isDragOver = false"
                        @drop.prevent="handleFileDrop($event)"
                    >
                        <div x-show="!selectedFile" class="space-y-4">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                            <div>
                                <p class="text-lg font-medium text-gray-700">Upload a face image</p>
                                <p class="text-sm text-gray-500">Drag and drop an image here, or click to browse</p>
                            </div>
                            <button 
                                type="button"
                                @click="$refs.fileInput.click()"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            >
                                <i class="fas fa-folder-open mr-2"></i>
                                Browse Files
                            </button>
                        </div>
                        
                        <!-- File Preview -->
                        <div x-show="selectedFile" class="space-y-4">
                            <div class="w-32 h-32 mx-auto rounded-lg overflow-hidden bg-gray-100">
                                <img 
                                    x-show="imagePreview" 
                                    :src="imagePreview" 
                                    alt="Preview" 
                                    class="w-full h-full object-cover"
                                >
                                <div x-show="!imagePreview" class="w-full h-full flex items-center justify-center">
                                    <i class="fas fa-image text-3xl text-gray-400"></i>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700" x-text="selectedFile?.name"></p>
                                <p class="text-xs text-gray-500" x-text="formatFileSize(selectedFile?.size)"></p>
                            </div>
                            <button 
                                type="button"
                                @click="removeFile()"
                                class="inline-flex items-center px-3 py-1 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                            >
                                <i class="fas fa-trash mr-1"></i>
                                Remove
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hidden file input -->
                    <input 
                        type="file" 
                        ref="fileInput"
                        @change="handleFileSelect($event)"
                        accept="image/*"
                        class="hidden"
                    >
                    
                    <!-- File requirements -->
                    <div class="mt-2 text-sm text-gray-500">
                        <p>Supported formats: JPG, JPEG, PNG</p>
                        <p>Maximum file size: 10MB</p>
                        <p>Ensure the image contains a clear, well-lit face</p>
                    </div>
                </div>

                <!-- Quality Check -->
                <div x-show="selectedFile && imageQuality" class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Image Quality Analysis</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Overall Quality</span>
                            <span class="text-sm font-medium" :class="getQualityColor(imageQuality.overall)">
                                <span x-text="(imageQuality.overall * 100).toFixed(0) + '%'"></span>
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" :style="'width: ' + (imageQuality.overall * 100) + '%'"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div>
                                <span class="text-xs text-gray-500">Sharpness</span>
                                <div class="flex justify-between">
                                    <span class="text-xs" x-text="(imageQuality.sharpness * 100).toFixed(0) + '%'"></span>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500">Brightness</span>
                                <div class="flex justify-between">
                                    <span class="text-xs" x-text="(imageQuality.brightness * 100).toFixed(0) + '%'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-4">
                    <button 
                        type="button"
                        @click="resetForm()"
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                        Reset
                    </button>
                    <button 
                        type="submit"
                        :disabled="!isFormValid || isSubmitting"
                        class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <div x-show="isSubmitting" class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                        <i x-show="!isSubmitting" class="fas fa-save mr-2"></i>
                        <span x-text="isSubmitting ? 'Registering...' : 'Register Face'"></span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Success Message -->
        <div x-show="showSuccess" x-transition class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <i class="fas fa-check text-green-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Registration Successful!</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            The face has been successfully registered in the system.
                        </p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button 
                            @click="showSuccess = false"
                            class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300"
                        >
                            Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function registerForm() {
            return {
                form: {
                    name: '',
                    email: ''
                },
                selectedFile: null,
                imagePreview: null,
                imageQuality: null,
                isDragOver: false,
                isSubmitting: false,
                showSuccess: false,
                
                get isFormValid() {
                    return this.form.name.trim() && this.selectedFile;
                },
                
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.processFile(file);
                    }
                },
                
                handleFileDrop(event) {
                    this.isDragOver = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.processFile(file);
                    }
                },
                
                processFile(file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        return;
                    }
                    
                    // Validate file size (10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File size must be less than 10MB');
                        return;
                    }
                    
                    this.selectedFile = file;
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                        this.analyzeImageQuality(e.target.result);
                    };
                    reader.readAsDataURL(file);
                },
                
                analyzeImageQuality(imageData) {
                    // Simulate image quality analysis
                    setTimeout(() => {
                        this.imageQuality = {
                            overall: 0.85 + Math.random() * 0.1,
                            sharpness: 0.8 + Math.random() * 0.15,
                            brightness: 0.7 + Math.random() * 0.2
                        };
                    }, 500);
                },
                
                getQualityColor(quality) {
                    if (quality >= 0.8) return 'text-green-600';
                    if (quality >= 0.6) return 'text-yellow-600';
                    return 'text-red-600';
                },
                
                formatFileSize(bytes) {
                    if (!bytes) return '';
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                },
                
                removeFile() {
                    this.selectedFile = null;
                    this.imagePreview = null;
                    this.imageQuality = null;
                    this.$refs.fileInput.value = '';
                },
                
                resetForm() {
                    this.form.name = '';
                    this.form.email = '';
                    this.removeFile();
                },
                
                async submitForm() {
                    if (!this.isFormValid) return;
                    
                    this.isSubmitting = true;
                    
                    try {
                        const formData = new FormData();
                        formData.append('name', this.form.name);
                        formData.append('email', this.form.email);
                        formData.append('face_image', this.selectedFile);
                        
                        const response = await fetch('/api/v1/faces/register', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.showSuccess = true;
                            this.resetForm();
                        } else {
                            alert('Registration failed: ' + (result.detail || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error submitting form:', error);
                        alert('Registration failed. Please try again.');
                    } finally {
                        this.isSubmitting = false;
                    }
                }
            }
        }
    </script>
</body>
</html>